---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = (await getCollection('blog')).filter((p) => !p.data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

function estimateReadTimeMinutes(text: string) {
  const words = text.split(/\s+/).filter(Boolean).length;
  return Math.max(1, Math.round(words / 200));
}

const readTime = post.data.readTime ?? estimateReadTimeMinutes(post.body);
const hasReadTime = Number.isFinite(readTime) && readTime > 0;
const hasViews = typeof post.data.views === 'number';

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: '2-digit',
});

const toc = (headings ?? []).filter((h) => h.depth >= 2 && h.depth <= 3);

function escapeHtml(input: string) {
  return input
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function renderInlineCode(input: string) {
  const codeClass =
    'rounded bg-zinc-100 px-1 py-0.5 font-mono text-[0.9em] text-zinc-900 dark:bg-zinc-800 dark:text-zinc-100';

  let out = '';
  let i = 0;

  while (i < input.length) {
    const tick = input.indexOf('`', i);
    if (tick === -1) {
      out += escapeHtml(input.slice(i));
      break;
    }

    out += escapeHtml(input.slice(i, tick));

    const isDouble = input.startsWith('``', tick);
    const openLen = isDouble ? 2 : 1;
    const close = input.indexOf(isDouble ? '``' : '`', tick + openLen);

    if (close === -1) {
      out += escapeHtml(input.slice(tick, tick + openLen));
      i = tick + openLen;
      continue;
    }

    const codeText = input.slice(tick + openLen, close);
    out += `<code class="${codeClass}">${escapeHtml(codeText)}</code>`;
    i = close + openLen;
  }

  return out;
}
---

<BaseLayout title={post.data.title} description={post.data.description} containerClass="max-w-6xl">
  <div class="lg:grid lg:grid-cols-[minmax(0,1fr)_20rem] lg:gap-10">
    <article class="prose prose-zinc prose-lg dark:prose-invert max-w-none">
      <div class="not-prose mb-8 space-y-3">
        <a
          href="/"
          class="text-sm text-zinc-600 no-underline hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-white"
        >
          ‚Üê Back
        </a>
        <h1 class="mb-0 text-[32px] font-semibold tracking-tight">
          <span set:html={renderInlineCode(post.data.title)} />
        </h1>
        <div class="text-base text-zinc-600 dark:text-zinc-400">{formattedDate}</div>
        {(hasReadTime || hasViews) && (
          <div class="flex items-center gap-3 text-sm text-zinc-500 dark:text-zinc-400">
            {hasReadTime && (
              <span class="inline-flex items-center gap-1">
                <svg
                  class="h-3.5 w-3.5"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 6v6l4 2" />
                </svg>
                <span>{readTime} min</span>
              </span>
            )}
            {hasViews && (
              <span class="inline-flex items-center gap-1">
                <svg
                  class="h-3.5 w-3.5"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
                <span>{post.data.views.toLocaleString()}</span>
              </span>
            )}
          </div>
        )}
        {(hasReadTime || hasViews) && (
          <div class="pt-3">
            <div class="h-px w-full bg-zinc-200 dark:bg-zinc-800"></div>
          </div>
        )}
        {post.data.description && (
          <p class="text-zinc-600 dark:text-zinc-300">
            <span set:html={renderInlineCode(post.data.description)} />
          </p>
        )}
      </div>
      <Content />
    </article>

    <script is:inline>
      (() => {
        const copyText = async (text) => {
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(text);
              return true;
            }
          } catch {
            // ignore
          }

          try {
            const el = document.createElement('textarea');
            el.value = text;
            el.setAttribute('readonly', '');
            el.style.position = 'fixed';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            return true;
          } catch {
            return false;
          }
        };

        const init = () => {
          const root = document.querySelector('article.prose');
          if (!root) return;

          root.addEventListener('click', async (e) => {
            const target = e.target;
            if (!(target instanceof HTMLElement)) return;

            const heading = target.closest('h2[id], h3[id], h4[id], h5[id], h6[id]');
            if (!heading) return;

            if (target.closest('a')) return;

            const id = heading.getAttribute('id');
            if (!id) return;

            const url = `${location.origin}${location.pathname}#${id}`;
            const ok = await copyText(url);
            if (ok) {
              history.replaceState(null, '', `#${id}`);
            }
          });
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      })();
    </script>

    <aside class="hidden lg:block">
      <div class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-auto">
        <div class="text-sm font-semibold text-zinc-700 dark:text-zinc-50">Table of content</div>
        {toc.length > 0 ? (
          <nav class="mt-3">
            <ul class="space-y-2 text-sm">
              {toc.map((h) => (
                <li class={h.depth === 3 ? 'pl-4' : ''}>
                  <a
                    class="group flex items-start gap-2 no-underline text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-white"
                    href={`#${h.slug}`}
                  >
                    <span class="leading-snug">{h.text}</span>
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        ) : (
          <div class="mt-3 text-sm text-zinc-600 dark:text-zinc-400">No headings</div>
        )}
      </div>
    </aside>
  </div>
</BaseLayout>
