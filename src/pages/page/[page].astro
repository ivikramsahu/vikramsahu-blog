---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import SnakesAndLadders from '../../components/SnakesAndLadders.astro';
import QuotesWidget from '../../components/QuotesWidget.astro';

const pageSize = 10;

export async function getStaticPaths() {
  const pageSize = 10;
  const posts = (await getCollection('blog'))
    .filter((p) => !p.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  const totalPages = Math.max(1, Math.ceil(posts.length / pageSize));

  if (totalPages <= 1) return [];

  return Array.from({ length: totalPages - 1 }, (_, i) => ({
    params: { page: String(i + 2) },
    props: { totalPages },
  }));
}

const pageParam = Number(Astro.params.page);
const currentPage = Number.isFinite(pageParam) && pageParam > 0 ? Math.floor(pageParam) : 1;

const posts = (await getCollection('blog'))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const totalPages = Astro.props.totalPages ?? Math.max(1, Math.ceil(posts.length / pageSize));

const start = (currentPage - 1) * pageSize;
const pagePosts = posts.slice(start, start + pageSize);

const prevHref =
  currentPage <= 1 ? null : currentPage === 2 ? '/' : `/page/${currentPage - 1}/`;
const nextHref = currentPage >= totalPages ? null : `/page/${currentPage + 1}/`;

function estimateReadTimeMinutes(text: string) {
  const words = text.split(/\s+/).filter(Boolean).length;
  return Math.max(1, Math.round(words / 200));
}

function escapeHtml(input: string) {
  return input
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function renderInlineCode(input: string) {
  const codeClass =
    'rounded bg-zinc-100 px-1 py-0.5 font-mono text-[0.9em] text-zinc-900 dark:bg-zinc-800 dark:text-zinc-100';

  let out = '';
  let i = 0;

  while (i < input.length) {
    const tick = input.indexOf('`', i);
    if (tick === -1) {
      out += escapeHtml(input.slice(i));
      break;
    }

    out += escapeHtml(input.slice(i, tick));

    const isDouble = input.startsWith('``', tick);
    const openLen = isDouble ? 2 : 1;
    const close = input.indexOf(isDouble ? '``' : '`', tick + openLen);

    if (close === -1) {
      out += escapeHtml(input.slice(tick, tick + openLen));
      i = tick + openLen;
      continue;
    }

    const codeText = input.slice(tick + openLen, close);
    out += `<code class="${codeClass}">${escapeHtml(codeText)}</code>`;
    i = close + openLen;
  }

  return out;
}
---

<BaseLayout title={`Blog (Page ${currentPage})`} description="Writing and notes." containerClass="max-w-7xl">
  <div class="space-y-10">
    <div class="space-y-2">
      <h1 class="text-[32px] font-semibold tracking-tight">Blog</h1>
      <p class="text-lg text-zinc-600 dark:text-zinc-400">Thoughts, notes, and small write-ups.</p>
    </div>

    <div class="lg:grid lg:grid-cols-[minmax(0,1fr)_22rem] lg:gap-8">
      <div>
        <div class="divide-y divide-zinc-200 overflow-hidden rounded-xl border border-zinc-200 bg-white dark:divide-zinc-800 dark:border-zinc-800 dark:bg-zinc-900">
          {pagePosts.map((post) => {
        const readTime = post.data.readTime ?? estimateReadTimeMinutes(post.body);
        const hasReadTime = Number.isFinite(readTime) && readTime > 0;
        const hasViews = typeof post.data.views === 'number';

        return (
          <a
            href={`/blog/${post.slug}/`}
            class="block p-[30px] no-underline hover:bg-zinc-50 dark:hover:bg-zinc-800"
          >
            <div class="space-y-4">
              <div class="flex items-baseline justify-between gap-6">
                <div class="min-w-0 flex-1 text-[24px] font-semibold leading-snug text-zinc-700 dark:text-zinc-50">
                  <span set:html={renderInlineCode(post.data.title)} />
                </div>
                <div class="shrink-0 text-right text-[15px] text-zinc-500 dark:text-zinc-400">
                  {post.data.date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit',
                  })}
                </div>
              </div>
              {post.data.description && (
                <div class="text-[15px] leading-relaxed text-zinc-600 dark:text-zinc-300">
                  <span set:html={renderInlineCode(post.data.description)} />
                </div>
              )}
              <div class="space-y-2 text-sm text-zinc-500 dark:text-zinc-400">
                {hasReadTime && (
                  <div class="inline-flex items-center gap-1">
                    <svg
                      class="h-3.5 w-3.5"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      aria-hidden="true"
                    >
                      <circle cx="12" cy="12" r="10" />
                      <path d="M12 6v6l4 2" />
                    </svg>
                    <span>{readTime} min read</span>
                  </div>
                )}
                {hasViews && (
                  <div class="inline-flex items-center gap-1">
                    <svg
                      class="h-3.5 w-3.5"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      aria-hidden="true"
                    >
                      <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z" />
                      <circle cx="12" cy="12" r="3" />
                    </svg>
                    <span>{post.data.views.toLocaleString()} views</span>
                  </div>
                )}
              </div>
            </div>
          </a>
        );
      })}

      {pagePosts.length === 0 && (
        <div class="p-5 text-sm text-zinc-600 dark:text-zinc-300">No posts found.</div>
      )}
        </div>

        {totalPages > 1 && (
          <nav class="mt-8 flex items-center justify-between">
            <div class="text-sm text-zinc-600 dark:text-zinc-400">
              Page {currentPage} of {totalPages}
            </div>
            <div class="flex items-center gap-2">
              {prevHref ? (
                <a
                  href={prevHref}
                  class="rounded-lg border border-zinc-200 px-3 py-2 text-sm text-zinc-700 no-underline hover:bg-zinc-50 dark:border-zinc-800 dark:text-zinc-200 dark:hover:bg-zinc-900"
                >
                  Prev
                </a>
              ) : (
                <span class="rounded-lg border border-zinc-200 px-3 py-2 text-sm text-zinc-400 dark:border-zinc-800 dark:text-zinc-600">
                  Prev
                </span>
              )}

              {nextHref ? (
                <a
                  href={nextHref}
                  class="rounded-lg border border-zinc-200 px-3 py-2 text-sm text-zinc-700 no-underline hover:bg-zinc-50 dark:border-zinc-800 dark:text-zinc-200 dark:hover:bg-zinc-900"
                >
                  Next
                </a>
              ) : (
                <span class="rounded-lg border border-zinc-200 px-3 py-2 text-sm text-zinc-400 dark:border-zinc-800 dark:text-zinc-600">
                  Next
                </span>
              )}
            </div>
          </nav>
        )}
      </div>

      <aside class="mt-8 lg:mt-0">
        <div class="lg:sticky lg:top-28 space-y-4">
          <QuotesWidget />
          <SnakesAndLadders />
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>
